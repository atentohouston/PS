###############################################################################################################################
# Firmar Ejecutables de windows para poder trabajar con ellos sin que windows defender nos detecte nuestras apps como malware.#
###############################################################################################################################
# === CONFIGURACIÓN ===
$programa = "C:\Users\pepe\Desktop\programa.exe"   # Ejecutable a firmar
$pfxPassword = "MiPassword123"                      # Cambiar a uno seguro
$timestampUrl = "http://timestamp.sectigo.com"

# === CREAR ROOT CA ===
$certRootName = "CN=MiCA-Raiz"
$rootCA = New-SelfSignedCertificate -Type Custom -KeyUsage CertSign, CRLSign, DigitalSignature `
    -Subject $certRootName -KeyLength 4096 -KeyExportPolicy Exportable `
    -HashAlgorithm sha256 -CertStoreLocation "Cert:\CurrentUser\My" `
    -KeyAlgorithm RSA

# Exportar Root CA a .cer
$rootCerPath = "$env:USERPROFILE\Desktop\MiCA-Raiz.cer"
Export-Certificate -Cert $rootCA -FilePath $rootCerPath | Out-Null

# Instalar Root CA como confiable
Import-Certificate -FilePath $rootCerPath -CertStoreLocation "Cert:\CurrentUser\Root" | Out-Null
Write-Host "✅ Root CA instalada como confiable."

# === CREAR CERTIFICADO HIJO PARA FIRMA DE CÓDIGO ===
$certCodeName = "CN=MiFirmaDeCodigo"
$codeCert = New-SelfSignedCertificate -Type CodeSigningCert -Subject $certCodeName `
    -Signer $rootCA -CertStoreLocation "Cert:\CurrentUser\My"

# Exportar a PFX
$pfxPath = "$env:USERPROFILE\Desktop\MiFirmaDeCodigo.pfx"
Export-PfxCertificate -Cert $codeCert -FilePath $pfxPath -Password (ConvertTo-SecureString -String $pfxPassword -Force -AsPlainText) | Out-Null
Write-Host "✅ Certificado de firma exportado a $pfxPath"

# === AÑADIR CERTIFICADO HIJO A TRUSTED PUBLISHER ===
$certCerPath = "$env:USERPROFILE\Desktop\MiFirmaDeCodigo.cer"
Export-Certificate -Cert $codeCert -FilePath $certCerPath | Out-Null
Import-Certificate -FilePath $certCerPath -CertStoreLocation "Cert:\CurrentUser\TrustedPublisher" | Out-Null
Write-Host "✅ Certificado hijo añadido a TrustedPublisher."

# === BUSCAR SIGNSIGNTOOL.EXE ===
$possiblePaths = @(
    "C:\Program Files (x86)\Windows Kits\10\bin",
    "C:\Program Files\Windows Kits\10\bin"
)

$signtool = $null
foreach ($base in $possiblePaths) {
    if (Test-Path $base) {
        $versions = Get-ChildItem $base -Directory | Sort-Object Name -Descending
        foreach ($ver in $versions) {
            $candidate = Join-Path $ver.FullName "x64\signtool.exe"
            if (Test-Path $candidate) {
                $signtool = $candidate
                break
            }
        }
    }
    if ($signtool) { break }
}

if (-not $signtool) {
    Write-Host "❌ No se encontró signtool.exe. Instala el Windows SDK y vuelve a intentar." -ForegroundColor Red
    exit 1
}
Write-Host "✅ Se usará signtool en: $signtool"

# === FIRMAR EL EJECUTABLE ===
& $signtool sign /a /f $pfxPath /p $pfxPassword /tr $timestampUrl /td sha256 /fd sha256 $programa
Write-Host "✅ Ejecutable firmado correctamente."

# === CREAR REGLA DE APPLOCKER PARA EJECUTABLES FIRMADOS ===
$cert = Get-ChildItem -Path Cert:\CurrentUser\TrustedPublisher | Where-Object { $_.Subject -eq "CN=$certCodeName" }

if ($cert) {
    if (-not (Get-Service AppIDSvc).Status -eq "Running") {
        Start-Service AppIDSvc
    }
    $rule = New-AppLockerPolicy -RuleType Publisher -User "Everyone" -SignedBy $cert -FilePath "C:\*" -Action Allow
    Set-AppLockerPolicy -PolicyObject $rule -Merge -ErrorAction Stop
    Write-Host "✅ Regla de AppLocker creada para permitir ejecutables firmados con $certCodeName."
} else {
    Write-Host "❌ No se encontró el certificado hijo en TrustedPublisher."
}

Write-Host "✅ Proceso completo. Tu ejecutable está firmado y configurado como confiable en tu PC."
